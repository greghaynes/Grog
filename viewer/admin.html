<html>
<head>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>

	<style type="text/css">
	body {
		font-family: sans-serif;
	}

	#logindiv {
		position: absolute;
		left: 50%;
		top: 100px;
		margin-left: -150px;
		width: 300px;
		opacity: 0;
	}

	#container {
		opacity: 0;
	}

	#navigation {
		float: left;
		list-style-type: none;
		margin: 0;
		padding: 10px;
	}
	</style>
</head>

<body>

<div id="logindiv">
	<h3>Please login</h3>
	Username: <input type="text" id="username"/><br />
	Password: <input type="password" id="password"/><br />
	<button id="login_button">Login</button><br />
	<span id="logindiv_errmsg"></span>
</div>

<div id="container">
	<ul id="navigation">
		<li><a href="#entries">Entries</a></li>
		<li><a href="#settings">Settings</a></li>
		<li><a href="#logout" id="logout">Log Out</a></li>
	</ul>

	<div id="content">
	</div>
</div>

<script type="text/javascript">
	var grogadmin = {
		is_logged_in: false,

		check_login: function(success, error) {
			$.getJSON('/user/whoami', function(data) {
				if('id' in data)
					grogadmin.is_logged_in = true;
				else
					grogadmin.is_logged_in = false;
				success(data);
			}, error);
		},

		login: function(username, password, success, error) {
			$.ajax({
				type: 'POST',
				url: '/user/login',
				data: {'username': username, 'password': password},
				success: function(data) {
					if('id' in data)
						grogadmin.is_logged_in = true;
					success(data);
					},
				error: error,
				dataType: 'json'});
		},

		logout: function(success) {
			$.getJSON('/user/logout', function(data) {
				if('id' in data)
					grogadmin.is_logged_in = false;
				success(data);
			});
		},
	};

	// Login dialog
	function login_dialog_hide() {
		$("#logindiv").animate({opacity: 0});
	}

	function login_dialog_show() {
		$("#logindiv").animate({opacity: '100%'});
	}

	function login_dialog_display_error(error) {
		if('type' in error) {
			if(error.type == 'Not Found')
				$("#logindiv_errmsg").html("Username or password incorrect.");
			else
				$("#logindiv_errmsg").html(error.type);
		} else {
			$("#logindiv_errmsg").html("Undefined error.");
		}
	}

	// content
	function page_hide() {
		$("#container").animate({opacity: 0});
	}

	function page_show() {
		$("#container").animate({opacity: '100%'});
	}

	function do_login(username, password) {
		console.log("logging in as "+username+" "+password);
		grogadmin.login(username, password, function(data) {
			if(grogadmin.is_logged_in) {
				login_dialog_hide();
				page_show();
			}
			else
				login_dialog_display_error(data);
		});
	}

	// Setup handlers
	$("#login_button").click(function(event) {
		do_login($("#username").val(), $("#password").val());
	});

	$("#logout").click(function(event) { grogadmin.logout(function(data) {
		page_hide();
		login_dialog_show();
		})
	});

	grogadmin.check_login(function(data) {
		if(!grogadmin.is_logged_in)
			login_dialog_show();
		else
			page_show();
	});

</script>

</body>

</html>
